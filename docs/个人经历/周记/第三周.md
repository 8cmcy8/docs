ä¹‹å‰å†™çš„éƒ½ä¸å¤ªå¥½ï¼Œåº”è¯¥åŠ ä¸ªå‘¨è®¡åˆ’çš„å†…å®¹ç„¶åçœ‹èƒ½å®Œæˆå¤šå°‘ï¼Œå†µä¸”è·ç¦»ç¬¬äºŒå‘¨çš„å·²ç»ç›¸éš”äº† 40 å¤©äº†ï¼ŒåŸå› æš‚ä¸”ä¸è¡¨

ç„¶åä¹‹å‰å…¶å®æ˜¯æœ‰ç¬¬ä¸‰å‘¨çš„ï¼Œä¹Ÿç®—å­¦äº†ç‚¹æœ‰ç”¨çš„ä¸œè¥¿ï¼Œä½†éƒ½è·Ÿå¼€å‘æœ‰å…³ï¼Œå°±æ˜¯å­¦ä¹ äº†åŸºç¡€çš„ gcc g++ è¿˜æœ‰ gdb è°ƒè¯•ä»¥åŠå†™ CMakeLists.txt æ–‡ä»¶(æ³¨æ„å¤§å°å†™ä¸¥æ ¼)

### è®¡åˆ’

ä¾ç„¶æ˜¯å‘ç€é€†å‘æ–¹é¢å­¦ï¼Œä¹‹å‰æŠŠ 16 ä½çš„ x86 æ±‡ç¼–çœ‹å®Œäº†ï¼Œarm æ±‡ç¼–ä¾æ—§æ²¡æ€ä¹ˆçœ‹ï¼Œarm æ–¹é¢çš„æˆ‘é€‰æ‹©ä¸ä¸“é—¨å»çœ‹ï¼Œçœ‹åˆ°ä¸ä¼šçš„åœ¨ä¸´æ—¶çœ‹ï¼Œæ‰€ä»¥å°±æ˜¯é€†å‘å·¥ç¨‹æƒå¨æŒ‡å—è¿™æœ¬ä¹¦

å†ç„¶åå°±æ˜¯å› ä¸ºä¹‹å‰æ¨å¤§å“¥æœ‰è®©æˆ‘ä»¬æè¿‡å›ºä»¶åˆ†æï¼Œå½“æ—¶å¤ªè ¢äº†å•¥éƒ½ä¸æ‡‚ï¼Œç°åœ¨æœ‰æ€è·¯äº†ï¼Œæˆ‘å…ˆæ˜¯çœ‹äº†ä¸‹ä¸»æµçš„è·¯ç”±å™¨æ¿å­ï¼Œå°±æ˜¯è®¤è¯†ä¸‹ cpuã€é—ªå­˜ã€å†…å­˜ã€ä¾›ç”µç­‰ã€‚æ¥ä¸‹æ¥å°±æ˜¯çœ‹ä¸€äº›ä¸»æµçš„å›ºä»¶ç³»ç»Ÿã€‚ç„¶åçœ‹äº†ä¸€ç¯‡ä½¿ç”¨ IDA é€†å‘ç¨‹åºçš„å¸–å­ï¼Œäº†è§£äº†ä¸€äº›ç”¨æ³•ä¹‹åï¼Œå¼€å§‹çœ‹ã€ŠIDA Pro æƒå¨æŒ‡å—ã€‹ã€‚è¿˜æœ‰è¿™æœ¬ã€Šé€†å‘å·¥ç¨‹æƒå¨æŒ‡å—ã€‹ã€‚

1. [ARMæ±‡ç¼–åŸºç¡€](https://azeria-labs.com/writing-arm-assembly-part-1/)èŠ±è´¹å‘¨ä¸€å‘¨äºŒçœ‹å®Œï¼Œçœ‹å®Œäº†ä¹‹åå°±èƒ½åŸºæœ¬æ— éšœç¢è¯»ã€Šé€†å‘å·¥ç¨‹æƒå¨æŒ‡å—ã€‹
2. ã€ŠIDA Pro æƒå¨æŒ‡å—ã€‹å‘¨ä¸‰å‘¨å››çœ‹ä¸‰ç« ç¬¬ä¸€éƒ¨åˆ†å†…å®¹
3. ã€Šé€†å‘å·¥ç¨‹æƒå¨æŒ‡å—ã€‹å‘¨äº”å‘¨å…­çœ‹ä¸‰ç« ç¬¬ä¸€éƒ¨åˆ†å†…å®¹
4. å…¶ä½™æ—¶é—´ä¼šå»è¡¥æ“ä½œç³»ç»Ÿçš„ä¸€äº›çŸ¥è¯†ï¼Œç„¶ååœ¨è¿™æœŸé—´å†™å‘¨æŠ¥

ç„¶åæˆ‘è®¤ä¸ºä¹Ÿå¾—çœ‹ä¸€ä¸‹å°è¿ªçš„è¯¾ç¨‹ï¼Œä»¥æˆ‘ç›®å‰çš„æ°´å¹³åœ¨é€†å‘æ–¹é¢åšä¸äº†ä»€ä¹ˆå®è´¨çš„ä¸œè¥¿

### 2024å¹´9æœˆ9æ—¥

#### ARM æ±‡ç¼–

##### ARM æ•°æ®ç±»å‹å’Œå¯„å­˜å™¨

1. ä¸é«˜çº§è¯­è¨€ç±»ä¼¼ï¼ŒARM æ”¯æŒå¯¹ä¸åŒæ•°æ®ç±»å‹çš„æ“ä½œã€‚

   ```shell
   ldr = åŠ è½½å­—
   ldr h = åŠ è½½æ— ç¬¦å·åŠå­—
   ldr sh = åŠ è½½æœ‰ç¬¦å·åŠå­—
   ldr b = åŠ è½½æ— ç¬¦å·å­—èŠ‚
   ldr sb = åŠ è½½æœ‰ç¬¦å·å­—èŠ‚
   å­— 32 ä½ åŠå­— 16 ä½ å­—èŠ‚ 8 ä½
   str = å­˜å‚¨å­—
   str h = å­˜å‚¨æ— ç¬¦å·åŠå­—
   str sh = å­˜å‚¨æœ‰ç¬¦å·åŠå­—
   str b = å­˜å‚¨æ— ç¬¦å·å­—èŠ‚
   str sb = å­˜å‚¨æœ‰ç¬¦å·å­—èŠ‚
   ```

2. å­—èŠ‚é¡ºåºæœ‰æ‰€ä¸åŒï¼Œx86 æ¶æ„åˆ†å¤§å°ç«¯æŸ¥çœ‹ï¼ŒARM æ¶æ„åœ¨ç‰ˆæœ¬ 3 ä¹‹å‰æ˜¯å°ç«¯ï¼Œä¹‹åæ˜¯åŒç«¯ï¼Œè¿™æ„å‘³ç€å®ƒå…·æœ‰å…è®¸å¯åˆ‡æ¢å­—èŠ‚åºçš„è®¾ç½®ã€‚ä¾‹å¦‚ï¼Œåœ¨ ARMv6 ä¸Šï¼ŒæŒ‡ä»¤æ˜¯å›ºå®šçš„å°ç«¯ï¼Œæ•°æ®è®¿é—®å¯ä»¥æ˜¯å°ç«¯æˆ–å¤§ç«¯ï¼Œç”±ç¨‹åºçŠ¶æ€å¯„å­˜å™¨ (CPSR) çš„ç¬¬ 9 ä½ï¼ˆE ä½ï¼‰æ§åˆ¶ã€‚

3. å¯„å­˜å™¨æ•°é‡å–å†³äº ARM ç‰ˆæœ¬ï¼Œæ ¹æ® ARM å‚è€ƒæ‰‹å†Œï¼Œå…±æœ‰ 30 ä¸ªé€šç”¨ 32 ä½å¯„å­˜å™¨ã€‚å‰ 16 ä¸ªå¯„å­˜å™¨å¯åœ¨ç”¨æˆ·çº§æ¨¡å¼ä¸‹è®¿é—®ï¼Œå…¶ä»–å¯„å­˜å™¨å¯åœ¨ç‰¹æƒè½¯ä»¶æ‰§è¡Œä¸­ä½¿ç”¨ã€‚

   > [!warning]
   >
   > ä»¥ä¸Šæ‰€è¯´çš„å†…å®¹ï¼ŒåŸºäº ARMv6-M å’Œ ARMv7-M çš„å¤„ç†å™¨é™¤å¤–ã€‚

4. 16ä¸ªé€šç”¨å¯„å­˜å™¨å…¶ä¸­çš„å‡ ä¸ªä¸ x86 æœ‰åŒºåˆ«

   - **LR**ï¼ˆé“¾æ¥å¯„å­˜å™¨ï¼‰ä¿å­˜å‡½æ•°è°ƒç”¨çš„ä¸‹ä¸€ä¸ªå†…å­˜åœ°å€ï¼Œæ–¹ä¾¿å­ç¨‹åºè¿”å›ã€‚x86 ä¸­æ²¡æœ‰ä¸“é—¨çš„ç”¨äºå‡½æ•°è°ƒç”¨çš„å¯„å­˜å™¨ï¼Œåªæœ‰ call ret ç»„åˆæ¥å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œcall çš„æ—¶å€™å°±ä¼šæŠŠä¸‹ä¸€ä¸ªåœ°å€å‹å…¥æ ˆã€‚

   - **PC**ï¼ˆç¨‹åºè®¡æ•°å™¨ï¼‰åœ¨ ARM çŠ¶æ€ä¸‹ï¼Œæ­¤å¤§å°å§‹ç»ˆä¸º 4 ä¸ªå­—èŠ‚ï¼Œåœ¨ THUMB æ¨¡å¼ä¸‹ï¼Œåˆ™ä¸º 2 ä¸ªå­—èŠ‚ã€‚æ‰§è¡Œåˆ†æ”¯æŒ‡ä»¤æ—¶ï¼ŒPC ä¿å­˜ç›®æ ‡åœ°å€ã€‚åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œåœ¨ ARM çŠ¶æ€ä¸‹ï¼ŒPC å­˜å‚¨å½“å‰æŒ‡ä»¤çš„åœ°å€åŠ  8ï¼ˆä¸¤ä¸ª ARM æŒ‡ä»¤ï¼‰ï¼Œåœ¨ Thumb(v1) çŠ¶æ€ä¸‹ï¼ŒPC å­˜å‚¨å½“å‰æŒ‡ä»¤çš„åœ°å€åŠ  4ï¼ˆä¸¤ä¸ª Thumb æŒ‡ä»¤ï¼‰ã€‚è¿™ä¸ x86 ä¸åŒï¼Œåœ¨ x86 ä¸­ï¼ŒPC å§‹ç»ˆæŒ‡å‘ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„æŒ‡ä»¤ã€‚

   - **CPSR**ï¼ˆå½“å‰ç¨‹åºçŠ¶æ€å¯„å­˜å™¨ï¼‰ç±»ä¼¼äº x86 ä¸­çš„æ ‡å¿—å¯„å­˜å™¨

     |     æ ‡å¿—      | æè¿°                                                         |
     | :-----------: | ------------------------------------------------------------ |
     |  N(Negative)  | å¦‚æœæŒ‡ä»¤çš„ç»“æœäº§ç”Ÿè´Ÿæ•°ï¼Œåˆ™å¯ç”¨ã€‚                             |
     |    Z(Zero)    | å¦‚æœæŒ‡ä»¤çš„ç»“æœäº§ç”Ÿé›¶å€¼ï¼Œåˆ™å¯ç”¨ã€‚                             |
     |   C(Carry)    | å¦‚æœæŒ‡ä»¤çš„ç»“æœäº§ç”Ÿäº†ä¸€ä¸ªéœ€è¦ç¬¬33ä½æ‰èƒ½å®Œå…¨è¡¨ç¤ºçš„å€¼ï¼Œåˆ™å¯ç”¨ã€‚ |
     |  V(Overflow)  | å¦‚æœæŒ‡ä»¤çš„ç»“æœäº§ç”Ÿäº†ä¸€ä¸ªåœ¨32ä½è¡¥ç ä¸­æ— æ³•è¡¨ç¤ºçš„å€¼ï¼Œåˆ™å¯ç”¨ã€‚   |
     | E(Endian-bit) | ARMå¯ä»¥æ“ä½œäºå°ç«¯æ¨¡å¼æˆ–å¤§ç«¯æ¨¡å¼ã€‚æ­¤ä½è®¾ç½®ä¸º0è¡¨ç¤ºå°ç«¯æ¨¡å¼ï¼Œæˆ–è®¾ç½®ä¸º1è¡¨ç¤ºå¤§ç«¯æ¨¡å¼ã€‚ |
     | T(Thumb-bit)  | å¦‚æœå¤„äºThumbçŠ¶æ€ï¼Œåˆ™æ­¤ä½è¢«è®¾ç½®ï¼›å¦‚æœå¤„äºARMçŠ¶æ€ï¼Œåˆ™æ­¤ä½è¢«ç¦ç”¨ã€‚ |
     | M(Mode-bits)  | è¿™äº›ä½æŒ‡å®šå½“å‰çš„ç‰¹æƒæ¨¡å¼ï¼ˆç”¨æˆ·æ¨¡å¼USRã€ç³»ç»Ÿæ¨¡å¼SVCç­‰ï¼‰ã€‚     |
     |  J(Jazelle)   | ç¬¬ä¸‰æ‰§è¡ŒçŠ¶æ€ï¼Œå…è®¸ä¸€äº›ARMå¤„ç†å™¨åœ¨ç¡¬ä»¶ä¸­æ‰§è¡ŒJavaå­—èŠ‚ç ã€‚      |

##### ARM æŒ‡ä»¤é›†

1. ARM å¤„ç†å™¨æœ‰ä¸¤ç§ä¸»è¦çš„è¿è¡ŒçŠ¶æ€ **ARM å’Œ THUMB**ã€‚è¿™äº›çŠ¶æ€ä¸ç‰¹æƒçº§åˆ«æ— å…³ã€‚è¿™ä¸¤ä¸ªçŠ¶æ€ä¹‹é—´çš„ä¸»è¦åŒºåˆ«åœ¨äºæŒ‡ä»¤é›†ï¼ŒARM çŠ¶æ€ä¸‹çš„æŒ‡ä»¤å§‹ç»ˆä¸º 32 ä½ï¼Œè€Œ Thumb çŠ¶æ€ä¸‹çš„æŒ‡ä»¤ä¸º 16 ä½ï¼ˆä½†å¯ä»¥æ˜¯ 32 ä½ï¼‰ã€‚éœ€è¦çŸ¥é“åœ¨å“ªäº›åœ°æ–¹ä½¿ç”¨Thumbä»£æ›¿ARMã€‚å¼•å…¥Thumbå¢å¼ºæŒ‡ä»¤é›†ä¹‹åï¼Œè¿˜éœ€è¦äº†è§£åˆ°è‡ªå·±çš„è®¾å¤‡æ”¯æŒçš„æ˜¯å“ªä¸€ç§ï¼Œå¹¶è¿›è¡Œç›¸åº”çš„è°ƒæ•´ã€‚

2. ARM å’Œ Thumb ä¹‹é—´çš„åŒºåˆ«ï¼š

   - æ¡ä»¶æ‰§è¡Œï¼šARM çŠ¶æ€ä¸‹çš„æ‰€æœ‰æŒ‡ä»¤éƒ½æ”¯æŒæ¡ä»¶æ‰§è¡Œã€‚æŸäº› ARM å¤„ç†å™¨ç‰ˆæœ¬å…è®¸ä½¿ç”¨ IT æŒ‡ä»¤åœ¨ Thumb ä¸­è¿›è¡Œæ¡ä»¶æ‰§è¡Œã€‚æ¡ä»¶æ‰§è¡Œå¯æé«˜ä»£ç å¯†åº¦ï¼Œå› ä¸ºå®ƒå‡å°‘äº†è¦æ‰§è¡Œçš„æŒ‡ä»¤æ•°é‡å¹¶å‡å°‘äº†æ˜‚è´µçš„åˆ†æ”¯æŒ‡ä»¤æ•°é‡ã€‚
   - 32 ä½ ARM å’Œ Thumb æŒ‡ä»¤ï¼š32 ä½ Thumb æŒ‡ä»¤å…·æœ‰ .w åç¼€ã€‚
   - æ¡¶å½¢ç§»ä½å™¨æ˜¯ ARM æ¨¡å¼çš„å¦ä¸€ä¸ªç‹¬ç‰¹åŠŸèƒ½ã€‚å®ƒå¯ç”¨äºå°†å¤šæ¡æŒ‡ä»¤ç¼©å‡ä¸ºä¸€æ¡ã€‚ä¾‹å¦‚ï¼Œæ‚¨æ— éœ€ä½¿ç”¨ä¸¤æ¡æŒ‡ä»¤è¿›è¡Œä¹˜æ³•è¿ç®—ï¼ˆå°†å¯„å­˜å™¨ä¹˜ä»¥ 2ï¼Œç„¶åä½¿ç”¨ MOV å°†ç»“æœå­˜å‚¨åˆ°å¦ä¸€ä¸ªå¯„å­˜å™¨ä¸­ï¼‰ï¼Œè€Œæ˜¯å¯ä»¥ä½¿ç”¨å·¦ç§» mov R1, R0, R0, LSL#1

3. åˆ‡æ¢å¤„ç†å™¨çš„æ‰§è¡ŒçŠ¶æ€ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶å¿…é¡»æ»¡è¶³:

   - æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åˆ†æ”¯æŒ‡ä»¤BXï¼ˆåˆ†æ”¯å’Œäº¤æ¢ï¼‰æˆ–BLXï¼ˆåˆ†æ”¯ï¼Œé“¾æ¥å’Œäº¤æ¢ï¼‰å¹¶å°†ç›®æ ‡å¯„å­˜å™¨çš„æœ€ä½æœ‰æ•ˆä½è®¾ç½®ä¸º1ã€‚å¯ä»¥é€šè¿‡æ·»åŠ 1çš„åç§»æ¥å®ç°ï¼Œå¦‚0x5530+ 1ã€‚è¿™ä¸ä¼šå› ä¸ºæŒ‡ä»¤è¦ä¹ˆæ˜¯2å­—èŠ‚ï¼Œè¦ä¹ˆæ˜¯4å­—èŠ‚å¯¹é½è€Œäº§ç”Ÿå¯¹é½é—®é¢˜ã€‚å› ä¸ºå¤„ç†å™¨å°†å¿½ç•¥æœ€ä½æœ‰æ•ˆä½ã€‚

   - å¦‚æœå½“å‰ç¨‹åºçŠ¶æ€å¯„å­˜å™¨ä¸­çš„Tä½ç½®1ï¼Œå¤„äºThumbæ¨¡å¼ã€‚

4. æŒ‡ä»¤é›†

   | æŒ‡ä»¤ |    æè¿°    |  æŒ‡ä»¤   |       æè¿°       |
   | :--: | :--------: | :-----: | :--------------: |
   | MOV  |  ç§»åŠ¨æ•°æ®  |   EOR   |    ä½è¿ç®—å¼‚æˆ–    |
   | MVN  | ç§»åŠ¨å¹¶å–å |   LDR   |       åŠ è½½       |
   | ADD  |    åŠ æ³•    |   STR   |       å­˜å‚¨       |
   | SUB  |    å‡æ³•    |   LDM   |     å¤šé‡åŠ è½½     |
   | MUL  |    ä¹˜æ³•    |   STM   |     å¤šé‡å­˜å‚¨     |
   | LSL  |  é€»è¾‘å·¦ç§»  |  PUSH   |      å‹å…¥æ ˆ      |
   | LSR  |  é€»è¾‘å³ç§»  |   POP   |    ä»æ ˆä¸­å¼¹å‡º    |
   | ASR  |  ç®—æœ¯å³ç§»  |    B    |       è·³è½¬       |
   | ROR  |   å³æ—‹è½¬   |   BL    |    åˆ†æ”¯å¹¶é“¾æ¥    |
   | CMP  |    æ¯”è¾ƒ    |   BX    |    åˆ†æ”¯å¹¶äº¤æ¢    |
   | AND  |  ä½è¿ç®—ä¸  |   BLX   | åˆ†æ”¯å¹¶é“¾æ¥å¹¶äº¤æ¢ |
   | ORR  |  ä½è¿ç®—æˆ–  | SWI/SVC |     ç³»ç»Ÿè°ƒç”¨     |

##### å†…å­˜æŒ‡ä»¤ï¼šåŠ è½½å’Œå­˜å‚¨

> [!tip]
>
> - ARM ä½¿ç”¨åŠ è½½-å­˜å‚¨æ¨¡å‹è¿›è¡Œå†…å­˜è®¿é—®ï¼Œè¿™æ„å‘³ç€åªæœ‰åŠ è½½/å­˜å‚¨ï¼ˆLDR å’Œ STRï¼‰æŒ‡ä»¤æ‰èƒ½è®¿é—®å†…å­˜ã€‚è™½ç„¶åœ¨ x86 ä¸Šï¼Œå¤§å¤šæ•°æŒ‡ä»¤éƒ½å…è®¸ç›´æ¥å¯¹å†…å­˜ä¸­çš„æ•°æ®è¿›è¡Œæ“ä½œï¼Œä½†åœ¨ ARM ä¸Šï¼Œæ•°æ®å¿…é¡»å…ˆä»å†…å­˜ç§»åˆ°å¯„å­˜å™¨ä¸­æ‰èƒ½è¿›è¡Œæ“ä½œã€‚è¿™æ„å‘³ç€åœ¨ ARM ä¸Šå¢åŠ ç‰¹å®šå†…å­˜åœ°å€çš„ 32 ä½å€¼éœ€è¦ä¸‰ç§ç±»å‹çš„æŒ‡ä»¤ï¼ˆåŠ è½½ã€å¢é‡å’Œå­˜å‚¨ï¼‰ï¼Œé¦–å…ˆå°†ç‰¹å®šåœ°å€çš„å€¼åŠ è½½åˆ°å¯„å­˜å™¨ä¸­ï¼Œåœ¨å¯„å­˜å™¨å†…å¢åŠ å®ƒï¼Œç„¶åå°†å…¶ä»å¯„å­˜å™¨å­˜å‚¨å›å†…å­˜ã€‚
> 
> - æ³¨æ„ ldr æ˜¯å³å€¼èµ‹å·¦å€¼ï¼Œstr æ˜¯å³å€¼èµ‹å·¦å€¼
>
> - æ³¨æ„å‰åç´¢å¼•çš„è®¡ç®—é¡ºåºï¼Œæœ€é‡è¦çš„æ˜¯å¤šçœ‹å¤šç†Ÿæ‚‰

###### åŸºæœ¬ç¤ºä¾‹

```assembly
LDR R2, [R0]	@ [R0] - origin address is the value found in R0.
STR R2, [R1]    @ [R1] - destination address is the value found in R1.
#LDR ç”¨äºä»å†…å­˜åŠ è½½æ•°æ®åˆ°å¯„å­˜å™¨ã€‚
STR ç”¨äºå°†å¯„å­˜å™¨ä¸­çš„æ•°æ®å­˜å‚¨åˆ°å†…å­˜ä¸­
```

ğŸ‘†å¾ˆç»å…¸ä»£ç å—ç›´æ¥è¯´æ¸…æ¥š LDR å’Œ STR å…³ç³»

å‡è®¾ï¼š

- `R0` ä¸­çš„å€¼æ˜¯ `0x1000`ï¼Œå†…å­˜åœ°å€ `0x1000` çš„å†…å®¹æ˜¯ `42`ã€‚
- `R1` ä¸­çš„å€¼æ˜¯ `0x2000`ã€‚

æ‰§è¡Œè¿™ä¸¤æ¡æŒ‡ä»¤åï¼š

- `LDR R2, [R0]` å°† `42` åŠ è½½åˆ° `R2` ä¸­ã€‚
- `STR R2, [R1]` å°† `42` å­˜å‚¨åˆ°å†…å­˜åœ°å€ `0x2000` ä¸­ã€‚

###### ç«‹å³æ•°ä½œä¸ºåç§»å¯»å€

```assembly
var1: .word 3  /* åœ¨å†…å­˜ä¸­å®šä¹‰å˜é‡1ï¼Œå€¼ä¸º3 */
var2: .word 4  /* åœ¨å†…å­˜ä¸­å®šä¹‰å˜é‡2ï¼Œå€¼ä¸º4 */

.text          /* ä»£ç æ®µå¼€å§‹ */
.global _start /* å£°æ˜å…¨å±€å…¥å£ç‚¹ */

_start:
    ldr r0, adr_var1  @ åŠ è½½ var1 çš„åœ°å€åˆ° R0
    ldr r1, adr_var2  @ åŠ è½½ var2 çš„åœ°å€åˆ° R1
    ldr r2, [r0]      @ ä» R0 æŒ‡å‘çš„åœ°å€åŠ è½½å€¼ (0x03) åˆ° R2
    str r2, [r1, #2]  @ ä½¿ç”¨åç§»é‡ï¼Œå°† R2 ä¸­çš„å€¼ (0x03) å­˜å‚¨åˆ° R1 + 2 çš„åœ°å€
    str r2, [r1, #4]! @ ä½¿ç”¨å‰ç´¢å¼•æ¨¡å¼ï¼Œå°† R2 ä¸­çš„å€¼ (0x03) å­˜å‚¨åˆ° R1 + 4 çš„åœ°å€ï¼ŒåŒæ—¶æ›´æ–° R1
                   #ğŸ‘†æ„Ÿå¹å·æ˜¯æ›´æ–° r1 çš„æ„æ€
    ldr r3, [r1], #4  @ ä½¿ç”¨åç´¢å¼•æ¨¡å¼ï¼Œä» R1 æŒ‡å‘çš„åœ°å€åŠ è½½å€¼åˆ° R3ï¼ŒåŒæ—¶æ›´æ–° R1
    bkpt              @ è®¾ç½®æ–­ç‚¹
```

ğŸ‘†å‰åç´¢å¼•å¯»å€çš„åŒºåˆ«

###### å¯„å­˜å™¨çš„å€¼ä½œä¸ºåç§»å¯»å€

```assembly
var1: .word 3  /* åœ¨å†…å­˜ä¸­å®šä¹‰å˜é‡1ï¼Œå€¼ä¸º3 */
var2: .word 4  /* åœ¨å†…å­˜ä¸­å®šä¹‰å˜é‡2ï¼Œå€¼ä¸º4 */

.text          /* ä»£ç æ®µå¼€å§‹ */
.global _start /* å£°æ˜å…¨å±€å…¥å£ç‚¹ */

_start:
    ldr r0, adr_var1  @ åŠ è½½ var1 çš„åœ°å€åˆ° R0
    ldr r1, adr_var2  @ åŠ è½½ var2 çš„åœ°å€åˆ° R1
    ldr r2, [r0]      @ ä» R0 æŒ‡å‘çš„åœ°å€åŠ è½½å€¼ (0x03) åˆ° R2
    str r2, [r1, r2]  @ ä½¿ç”¨åç§»é‡ï¼Œå°† R2 ä¸­çš„å€¼ (0x03) å­˜å‚¨åˆ° R1 + R2 çš„åœ°å€
    str r2, [r1, r2]! @ ä½¿ç”¨å‰ç´¢å¼•æ¨¡å¼ï¼Œå°† R2 ä¸­çš„å€¼ (0x03) å­˜å‚¨åˆ° R1 + R2 çš„åœ°å€ï¼ŒåŒæ—¶æ›´æ–° R1
    ldr r3, [r1], r2  @ ä½¿ç”¨åç´¢å¼•æ¨¡å¼ï¼Œä» R1 æŒ‡å‘çš„åœ°å€åŠ è½½å€¼åˆ° R3ï¼ŒåŒæ—¶æ›´æ–° R1
    bx lr              @ è¿”å›
```

ğŸ‘†å‰åç´¢å¼•å¯»å€çš„åŒºåˆ«

###### ç§»ä½å¯„å­˜å™¨ä½œä¸ºåç§»

```assembly
var1: .word 3  /* åœ¨å†…å­˜ä¸­å®šä¹‰å˜é‡1ï¼Œå€¼ä¸º3 */
var2: .word 4  /* åœ¨å†…å­˜ä¸­å®šä¹‰å˜é‡2ï¼Œå€¼ä¸º4 */

.text          /* ä»£ç æ®µå¼€å§‹ */
.global _start /* å£°æ˜å…¨å±€å…¥å£ç‚¹ */

_start:
    ldr r0, adr_var1         @ åŠ è½½ var1 çš„åœ°å€åˆ° R0
    ldr r1, adr_var2         @ åŠ è½½ var2 çš„åœ°å€åˆ° R1
    ldr r2, [r0]             @ ä» R0 æŒ‡å‘çš„åœ°å€åŠ è½½å€¼ (0x03) åˆ° R2
    str r2, [r1, r2, LSL#2]  @ ä½¿ç”¨åç§»é‡ï¼Œå°† R2 ä¸­çš„å€¼ (0x03) å­˜å‚¨åˆ° R1 + (R2 << 2) çš„åœ°å€
    str r2, [r1, r2, LSL#2]! @ ä½¿ç”¨å‰ç´¢å¼•æ¨¡å¼ï¼Œå°† R2 ä¸­çš„å€¼ (0x03) å­˜å‚¨åˆ° R1 + (R2 << 2) çš„åœ°å€ï¼ŒåŒæ—¶æ›´æ–° R1
    ldr r3, [r1], r2, LSL#2  @ ä½¿ç”¨åç´¢å¼•æ¨¡å¼ï¼Œä» R1 æŒ‡å‘çš„åœ°å€åŠ è½½å€¼åˆ° R3ï¼ŒåŒæ—¶æ›´æ–° R1
    bkpt                      @ è®¾ç½®æ–­ç‚¹
```

###### LDR ç”¨äºPCç›¸å¯¹å¯»å€

```assembly
.section .text
.global _start

_start:
   ldr r0, =jump        /* load the address of the function label jump into R0 */
   ldr r1, =0x68DB00AD  /* load the value 0x68DB00AD into R1 */
jump:
   ldr r2, =511         /* load the value 511 into R2 */ 
   bkpt
```

 ä¸ºä»€ä¹ˆæˆ‘ä»¬æœ‰æ—¶éœ€è¦ä½¿ç”¨è¿™ç§è¯­æ³•æ¥ä½¿ç”¨ä¸€ä¸ªæŒ‡ä»¤å°†32ä½å¸¸é‡ç§»åˆ°ä¸€ä¸ªçš„å¯„å­˜å™¨ä¸­å‘¢ï¼Œè¿™æ˜¯å› ä¸ºARMä¸€æ¬¡ åªèƒ½åŠ è½½ä¸€ä¸ª8ä½çš„å€¼ã€‚ä»€ä¹ˆï¼Ÿè¦ç†è§£ä¸ºä»€ä¹ˆï¼Œä½ éœ€è¦çŸ¥é“ARMä¸Šçš„ç«‹å³æ•°æ˜¯å¦‚ä½•å¤„ç†çš„ã€‚

###### ARM ä¸­ç«‹å³æ•°çš„ä½¿ç”¨

```assembly
.section .text
.global _start

_start:
	mov r0, #256
	add r0, #255
	ldr r1, =511    /* load 511 from the literal pool using LDR */
	bkpt
#æœ€ç»ˆ r0 ç»“æœæ˜¯511ï¼Œr1 ç»“æœä¹Ÿæ˜¯511
```

##### è½½å…¥/å­˜å‚¨å¤šä¸ªå€¼

æœ‰æ—¶å€™ä¸€æ¬¡åŠ è½½æˆ–è€…å­˜å‚¨å¤šä¸ªå€¼ä¼šæ›´æœ‰æ•ˆç‡ã€‚å› æ­¤æˆ‘ä»¬ä¼šä½¿ç”¨ `LDM`ï¼ˆload multiple) æŒ‡ä»¤å’Œ `STM`(store multiple) æŒ‡ä»¤ï¼Œè¿™äº›æŒ‡ä»¤æœ‰ä¸€äº›åœ¨è®¿é—®åˆå§‹åœ°å€æ–¹å¼ä¸Šæœ‰æ‰€ä¸åŒ

```assembly
.data

array_buff:
 .word 0x00000000             /* array_buff[0] */
 .word 0x00000000             /* array_buff[1] */
 .word 0x00000000             /* array_buff[2]. This element has a relative address of array_buff+8 */
 .word 0x00000000             /* array_buff[3] */
 .word 0x00000000             /* array_buff[4] */

.text
.global _start

_start:
 adr r0, words+12             /* r0 = &words[3] (0x00000003) */
 ldr r1, array_buff_bridge    /* r1 = &array_buff[0] */
 ldr r2, array_buff_bridge+4  /* r2 = &array_buff[2] */
 ldm r0, {r4,r5}              /* ä» r0 åŠ è½½ words[3] å’Œ words[4] åˆ° r4 å’Œ r5 */
 stm r1, {r4,r5}              /* å°† r4 å’Œ r5 çš„å€¼å­˜å‚¨åˆ° array_buff[0] å’Œ array_buff[1] */
 ldmia r0, {r4-r6}            /* ä» r0 åŠ è½½ words[3], words[4], words[5] åˆ° r4, r5, r6 */
 stmia r1, {r4-r6}            /* å°† r4, r5, r6 å­˜å‚¨åˆ° array_buff[0], array_buff[1], array_buff[2] */
 ldmib r0, {r4-r6}            /* é€å­—èŠ‚åŠ è½½ words[4], words[5], words[6] åˆ° r4, r5, r6 */
 stmib r1, {r4-r6}            /* é€å­—èŠ‚å­˜å‚¨ r4, r5, r6 åˆ° array_buff[1], array_buff[2], array_buff[3] */
 ldmda r0, {r4-r6}            /* ä» r0 åŠ è½½ words[3], words[2], words[1] åˆ° r6, r5, r4 */
 ldmdb r0, {r4-r6}            /* ä» r0 åŠ è½½ words[2], words[1], words[0] åˆ° r6, r5, r4 */
 stmda r2, {r4-r6}            /* å­˜å‚¨ r6, r5, r4 åˆ° array_buff[2], array_buff[1], array_buff[0] */
 stmdb r2, {r4-r5}            /* å­˜å‚¨ r5, r4 åˆ° array_buff[1], array_buff[0] */
 bx lr
 
 words:
 .word 0x00000000             /* words[0] */
 .word 0x00000001             /* words[1] */
 .word 0x00000002             /* words[2] */
 .word 0x00000003             /* words[3] */
 .word 0x00000004             /* words[4] */
 .word 0x00000005             /* words[5] */
 .word 0x00000006             /* words[6] */

array_buff_bridge:
 .word array_buff             /* address of array_buff, or in other words - array_buff[0] */
 .word array_buff+8           /* address of array_buff[2] */
```

ğŸ‘†ä¸»è¦ç›®çš„å°±æ˜¯è¦è®°ä½ adrï¼ˆåŠ è½½ä¸€ä¸ªæ ‡ç­¾çš„åœ°å€åˆ°å¯„å­˜å™¨ï¼‰ã€ldrã€ldmã€stmã€ldmiaã€stmibã€ldmdaã€ldmdbã€stmdaã€stmdb

ä½†è¯´å®è¯æš‚æ—¶ä¸ºäº†å¿«é€Ÿè¿‡ä¸€éç™¾åˆ†ç™¾æ˜¯è®°ä¸ä½çš„å°±åªæ˜¯çœ‹äº†ä¸€éç†è§£äº†ä¸€ä¸‹ç­‰åˆ°åé¢çœ‹åˆ°çš„æ—¶å€™å†è¯´å§:joy:ã€‚

### 2024å¹´9æœˆ10æ—¥

#### ARM æ±‡ç¼–

##### å‡ºæ ˆå’Œå…¥æ ˆ

```assembly
.text
.globa _start

_start:
	mov r0, #3
	mov r1. #4
	push {r0, r1}
	pop {r2, r3}
	stmdb sp!, {r0, r1}
	ldmia sp!, {r4, r5}
```

ğŸ‘†å’Œ x86 å·®ä¸å¤šå°±æ˜¯å¯ä»¥ä¸€æ¬¡æ€§ push & pop å¥½å‡ ä¸ªï¼Œè‡³äº push å’Œ pop çš„é¡ºåºéƒ½æ˜¯å…ˆå³å†å·¦

 ##### ARM æ¡ä»¶æ‰§è¡ŒæŒ‡ä»¤ && Thumbæ¨¡å¼ä¸‹çš„æ¡ä»¶æ‰§è¡Œ && åˆ†æ”¯æŒ‡ä»¤

ä¸‹é¢åˆ—å‡ºäº†å¸¸ç”¨çš„æ¡ä»¶ï¼Œä»¥åŠä»–ä»¬å½±å“çš„CPSRå¯„å­˜å™¨çš„æ¡ä»¶ä½:

- **Z (Zero Flag)**: å½“ç»“æœä¸ºé›¶æ—¶è®¾ç½®ã€‚
- **N (Negative Flag)**: å½“ç»“æœä¸ºè´Ÿæ—¶è®¾ç½®ã€‚
- **C (Carry Flag)**: åœ¨æ— ç¬¦å·è¿ç®—ä¸­ï¼Œå½“å‘ç”Ÿè¿›ä½æ—¶è®¾ç½®ã€‚
- **V (Overflow Flag)**: å½“æœ‰ç¬¦å·è¿ç®—çš„ç»“æœæº¢å‡ºæ—¶è®¾ç½®ã€‚

| **Condition Code** |           **å«ä¹‰**           | **Status of Flags**  |
| :----------------: | :--------------------------: | :------------------: |
|       **EQ**       |             ç­‰äº             |        Z == 1        |
|       **NE**       |            ä¸ç­‰äº            |        Z == 0        |
|       **GT**       |          æœ‰ç¬¦å·å¤§äº          | (Z == 0) && (N == V) |
|       **LT**       |          æœ‰ç¬¦å·å°äº          |        N != V        |
|       **GE**       |       æœ‰ç¬¦å·å¤§äºæˆ–ç­‰äº       |        N == V        |
|       **LE**       |       æœ‰ç¬¦å·å°äºæˆ–ç­‰äº       |       (Z == 1)       |
|    **CS or HS**    | æ— ç¬¦å·å¤§äºæˆ–ç›¸ç­‰ï¼ˆè¿›ä½è®¾ç½®ï¼‰ |        C == 1        |
|    **CC or LO**    |    æ— ç¬¦å·å°äºï¼ˆè¿›ä½æ¸…é™¤ï¼‰    |        C == 0        |
|       **MI**       |        è´Ÿæ•°ï¼ˆæˆ–è´Ÿå€¼ï¼‰        |        N == 1        |
|       **PL**       |        æ­£æ•°ï¼ˆæˆ–æ­£å€¼ï¼‰        |        N == 0        |
|       **AL**       |           å§‹ç»ˆæ‰§è¡Œ           |          â€“           |
|       **NV**       |           ä»ä¸æ‰§è¡Œ           |          â€“           |
|       **VS**       |          æœ‰ç¬¦å·æº¢å‡º          |        V == 1        |
|       **VC**       |        æ²¡æœ‰æœ‰ç¬¦å·æº¢å‡º        |        V == 0        |
|       **HI**       |          æ— ç¬¦å·å¤§äº          | (C == 1) && (Z == 0) |
|       **LS**       |       æ— ç¬¦å·å°äºæˆ–ç›¸ç­‰       |       (C == 0)       |

ä¾‹å­

```assembly
.global main

main:
        mov     r0, #2          /* è®¾ç½®åˆå§‹å˜é‡ r0 ä¸º 2 */
        cmp     r0, #3          /* å°† r0 ä¸æ•°å­— 3 è¿›è¡Œæ¯”è¾ƒï¼Œè´Ÿæ ‡å¿—ä½è¢«è®¾ç½®ä¸º 1 */
        addlt   r0, r0, #1      /* å¦‚æœ r0 å°äº 3ï¼Œåˆ™å°† r0 å¢åŠ  1 */
        cmp     r0, #3          /* å†æ¬¡å°† r0 ä¸æ•°å­— 3 è¿›è¡Œæ¯”è¾ƒï¼Œé›¶æ ‡å¿—ä½è¢«è®¾ç½®ä¸º 1 */
        addlt   r0, r0, #1      /* å¦‚æœ r0 å°äº 3ï¼Œåˆ™å°† r0 å†æ¬¡å¢åŠ  1 */
        bx      lr              /* è¿”å›åˆ°è°ƒç”¨è€… */
```

###### Thumb ä¸­çš„æ¡ä»¶æ‰§è¡Œ

- åœ¨å‰é¢æˆ‘ä»¬è¯´è¿‡å­˜åœ¨ä¸åŒç‰ˆæœ¬çš„Thumbçš„æƒ…å†µï¼Œå…·ä½“æ¥è¯´ï¼Œæœ‰å…è®¸æ¡ä»¶æ‰§è¡Œçš„Thumbç‰ˆæœ¬(Thumb-2)ã€‚æŸäº›ARMå¤„ç†å™¨çš„ç‰ˆæœ¬æ”¯æŒITæŒ‡ä»¤ï¼Œè¯¥æŒ‡ä»¤æœ€å¤šå¯ä»¥åœ¨ThumbçŠ¶æ€ä¸‹æœ‰æ¡ä»¶çš„æ‰§è¡Œ4æ¡æŒ‡ä»¤ã€‚

  è¯­æ³•:`IT {x {y {z}}} cond`

  - `cond`è§„å®šäº†æ‰§è¡ŒITè¯­å¥å—é‡Œçš„ç¬¬ä¸€æ¡æŒ‡ä»¤éœ€è¦æ»¡è¶³çš„æ¡ä»¶

  - `x`è§„å®šäº†æ‰§è¡Œçš„ITè¯­å¥å—ä¸­ç¬¬äºŒæ¡æŒ‡ä»¤éœ€è¦æ»¡è¶³çš„æ¡ä»¶

  - `y`è§„å®šäº†æ‰§è¡ŒITè¯­å¥å—é‡Œçš„ç¬¬ä¸‰æ¡æŒ‡ä»¤éœ€è¦æ»¡è¶³çš„æ¡ä»¶

  - `z` è§„å®šäº†æ‰§è¡ŒITè¯­å¥å—é‡Œçš„ç¬¬å››æ¡æŒ‡ä»¤éœ€è¦æ»¡è¶³çš„æ¡ä»¶

    ITæŒ‡ä»¤é›†çš„ç»“æ„æ˜¯ï¼š â€œIF-Then-(Else)â€ï¼Œå®ƒçš„è¯­æ³•ç»“æ„ç”±ä¸¤ä¸ªå­—æ¯æ„æˆï¼š

  - ITä»£è¡¨If-Thenï¼ˆä¸‹ä¸€æ¡æŒ‡ä»¤æ˜¯æ¡ä»¶æŒ‡ä»¤ï¼‰

  - TTä»£è¡¨If-Then-Thenï¼ˆæ¥ä¸‹æ¥çš„ä¸¤æ¡æŒ‡ä»¤æ˜¯æ¡ä»¶æŒ‡ä»¤ï¼‰

  - ITEä»£è¡¨ If-Then-Elseï¼ˆæ¥ä¸‹æ¥çš„ä¸¤æ¡æŒ‡ä»¤æ˜¯æ¡ä»¶æŒ‡ä»¤ï¼‰

  - ITTEä»£è¡¨ If-Then-Then-Else ï¼ˆæ¥ä¸‹æ¥çš„ä¸‰æ¡æŒ‡ä»¤æ˜¯æ¡ä»¶æŒ‡ä»¤ï¼‰

  - ITTEEä»£è¡¨ If-Then-Then-Else-Else ï¼ˆæ¥ä¸‹æ¥çš„å››æ¡æŒ‡ä»¤æ˜¯æ¡ä»¶æŒ‡ä»¤ï¼‰

    ITå—ä¸­çš„æ¯æ¡æŒ‡ä»¤å¿…é¡»æŒ‡å®šä¸€ä¸ªæ¡ä»¶åç¼€ï¼Œè¯¥æ¡ä»¶åç¼€å¯ä»¥æ˜¯ç›¸åŒçš„ï¼Œä¹Ÿå¯ä»¥æ˜¯åœ¨é€»è¾‘ç›¸åçš„ã€‚ è¿™æ„å‘³ç€ï¼Œå¦‚æœä½¿ç”¨äº†ITEï¼Œç¬¬ä¸€å’Œç¬¬äºŒæŒ‡ä»¤ï¼ˆIf-Thenï¼‰å¿…é¡»å…·æœ‰ç›¸åŒçš„æ¡ä»¶åç¼€ï¼Œè€Œç¬¬ä¸‰æ¡æŒ‡ä»¤ï¼ˆelseè¯­å¥ï¼‰å¿…é¡»å’Œå‰é¢ä¸¤æ¡è¯­å¥é€»è¾‘ç›¸åã€‚

    ```assembly
    ITTE   NE           ; Next 3 instructions are conditional
    ANDNE  R0, R0, R1   ; ANDNE does not update condition flags
    ADDSNE R2, R2, #1   ; ADDSNE updates condition flags
    MOVEQ  R2, R3       ; Conditional move
    
    ITE    GT           ; Next 2 instructions are conditional
    ADDGT  R1, R0, #55  ; Conditional addition in case the GT is true
    ADDLE  R1, R0, #48  ; Conditional addition in case the GT is not true
    
    ITTEE  EQ           ; Next 4 instructions are conditional
    MOVEQ  R0, R1       ; Conditional MOV
    ADDEQ  R2, R2, #10  ; Conditional ADD
    ANDNE  R3, R3, #1   ; Conditional AND
    BNE.W  dloop        ; Branch instruction can only be used in the last instruction of an IT block
    ```

    



































